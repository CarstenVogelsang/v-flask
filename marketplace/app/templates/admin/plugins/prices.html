{% extends "admin/base.html" %}

{% block breadcrumb_items %}
<li><a href="{{ url_for('marketplace_admin.plugin_list') }}">Plugins</a></li>
<li>{{ plugin.display_name }}</li>
<li>Preise</li>
{% endblock %}

{% block admin_content %}
<div class="flex justify-between items-center mb-6">
    <div>
        <h1 class="text-2xl font-bold">
            <i class="ti ti-currency-euro mr-2"></i>Preise: {{ plugin.display_name }}
        </h1>
        <p class="text-base-content/60 mt-1">
            Basispreis: <span class="font-medium">{{ plugin.price_display }}</span>
        </p>
    </div>
    <a href="{{ url_for('marketplace_admin.plugin_list') }}" class="btn btn-ghost">
        <i class="ti ti-arrow-left mr-1"></i>Zurück
    </a>
</div>

{% if not project_types %}
<div class="alert alert-warning mb-6">
    <i class="ti ti-alert-triangle"></i>
    <span>Keine aktiven Projekttypen gefunden. <a href="{{ url_for('marketplace_admin.project_type_list') }}" class="link">Projekttypen verwalten</a></span>
</div>
{% else %}

<div class="card bg-base-100 shadow mb-6">
    <div class="card-body">
        <h2 class="card-title text-lg mb-4">
            <i class="ti ti-table mr-1"></i>Preismatrix
        </h2>

        <div class="overflow-x-auto">
            <table class="table">
                <thead>
                    <tr>
                        <th class="w-32">Zyklus</th>
                        {% for pt in project_types %}
                        <th class="text-center"{% if pt.sort_order >= 100 %} style="background-color: #f5f5f5; border-left: 4px solid #6366f1;"{% endif %}>
                            {{ pt.name }}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for cycle in billing_cycles %}
                    {# Only show 'once' cycle if plugin allows one-time purchases #}
                    {% if cycle != 'once' or plugin.allow_one_time_purchase %}
                    <tr>
                        <td class="font-medium">
                            {% if cycle == 'once' %}Einmalig
                            {% elif cycle == 'monthly' %}Monatlich
                            {% elif cycle == 'yearly' %}Jährlich <span class="text-xs text-success">({{ yearly_discount }}% Ersparnis)</span>
                            {% else %}{{ cycle }}{% endif %}
                        </td>
                        {% for pt in project_types %}
                        {% set price = price_matrix.get((pt.id, cycle)) %}
                        <td class="text-center"{% if pt.sort_order >= 100 %} style="background-color: #f5f5f5; border-left: 4px solid #6366f1;"{% endif %}>
                            {% if cycle == 'yearly' %}
                            {# Yearly price is auto-calculated from monthly - read-only display #}
                            <span class="input input-bordered input-sm w-24 text-right bg-base-200 cursor-not-allowed inline-flex items-center justify-end"
                                  title="Wird automatisch aus Monatlich berechnet">
                                {{ '%0.2f' % (price.price_cents / 100) if price else '0,00' | replace('.', ',') }}
                            </span>
                            {% else %}
                            <input type="text"
                                   name="value"
                                   value="{{ '%0.2f' % (price.price_cents / 100) if price else '0,00' | replace('.', ',') }}"
                                   class="input input-bordered input-sm w-24 text-right"
                                   hx-post="{{ url_for('marketplace_admin.plugin_prices', plugin_id=plugin.id) }}"
                                   hx-trigger="blur changed"
                                   hx-vals='{"project_type_id": {{ pt.id }}, "billing_cycle": "{{ cycle }}", "field": "price_cents"}'
                                   {% if cycle == 'monthly' %}hx-on::after-request="location.reload()"{% endif %}
                                   hx-swap="outerHTML">
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="text-sm text-base-content/60 mt-4">
            <i class="ti ti-info-circle mr-1"></i>
            Preise in Euro eingeben (z.B. "99,00"). Änderungen werden automatisch gespeichert.
            <br>
            <i class="ti ti-calculator mr-1"></i>
            Jährliche Preise werden automatisch aus den monatlichen Preisen berechnet (Monatlich × 12 × {{ 100 - yearly_discount }}%).
        </div>
    </div>
</div>

<div class="card bg-base-100 shadow">
    <div class="card-body">
        <h2 class="card-title text-lg mb-4">
            <i class="ti ti-settings mr-1"></i>Setup-Gebühren
        </h2>

        <div class="overflow-x-auto">
            <table class="table">
                <thead>
                    <tr>
                        <th class="w-32">Typ</th>
                        {% for pt in project_types %}
                        <th class="text-center"{% if pt.sort_order >= 100 %} style="background-color: #f5f5f5; border-left: 4px solid #6366f1;"{% endif %}>
                            {{ pt.name }}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="font-medium">Einrichtung</td>
                        {% for pt in project_types %}
                        {% set price = price_matrix.get((pt.id, 'once')) %}
                        <td class="text-center"{% if pt.sort_order >= 100 %} style="background-color: #f5f5f5; border-left: 4px solid #6366f1;"{% endif %}>
                            <input type="text"
                                   name="value"
                                   value="{{ '%0.2f' % (price.setup_fee_cents / 100) if price else '0,00' | replace('.', ',') }}"
                                   class="input input-bordered input-sm w-24 text-right"
                                   hx-post="{{ url_for('marketplace_admin.plugin_prices', plugin_id=plugin.id) }}"
                                   hx-trigger="blur changed"
                                   hx-vals='{"project_type_id": {{ pt.id }}, "billing_cycle": "once", "field": "setup_fee_cents"}'
                                   hx-swap="outerHTML">
                        </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="text-sm text-base-content/60 mt-4">
            <i class="ti ti-info-circle mr-1"></i>
            Einmalige Setup-Gebühren werden nur bei der ersten Bestellung berechnet.
        </div>
    </div>
</div>

{% endif %}
{% endblock %}
