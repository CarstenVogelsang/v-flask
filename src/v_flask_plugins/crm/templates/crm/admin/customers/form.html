{% extends "admin/base.html" %}

{% block title %}{% if customer %}{{ customer.company_name }} bearbeiten{% else %}Neuer Kunde{% endif %}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs text-sm">
    <ul>
        <li><a href="{{ url_for('admin.dashboard') }}"><i class="ti ti-home"></i> Admin</a></li>
        <li><i class="ti ti-briefcase mr-1"></i>Verwaltung</li>
        <li><a href="{{ url_for('crm_admin.list_customers') }}">Kunden</a></li>
        <li>{% if customer %}{{ customer.customer_number }}{% else %}Neu{% endif %}</li>
    </ul>
</div>
{% endblock %}

{% block admin_content %}
{# Title Bar #}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold flex items-center gap-2">
        <i class="ti ti-user text-primary"></i>
        {% if customer %}
        <span>{{ customer.company_name }}</span>
        <span class="badge badge-neutral">{{ customer.customer_number }}</span>
        {% else %}
        <span>Neuer Kunde</span>
        {% endif %}
    </h1>
    <a href="{{ url_for('crm_admin.list_customers') }}" class="btn btn-ghost btn-sm">
        <i class="ti ti-arrow-left mr-1"></i> Zurück
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    {# Main Form #}
    <div class="lg:col-span-2">
        <form method="POST"
              action="{% if customer %}{{ url_for('crm_admin.edit_customer', customer_id=customer.id) }}{% else %}{{ url_for('crm_admin.new_customer') }}{% endif %}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            {# Stammdaten Card #}
            <div class="card bg-base-100 shadow mb-6">
                <div class="card-body">
                    <h2 class="card-title text-lg mb-4">
                        <i class="ti ti-building text-primary"></i> Stammdaten
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {# Company Name #}
                        <div class="form-control md:col-span-2">
                            <label class="label">
                                <span class="label-text">Firmenname *</span>
                            </label>
                            <input type="text"
                                   name="company_name"
                                   value="{{ customer.company_name if customer else '' }}"
                                   class="input input-bordered"
                                   required>
                        </div>

                        {# Legal Form #}
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Rechtsform</span>
                            </label>
                            <select name="legal_form" class="select select-bordered">
                                <option value="">Keine Angabe</option>
                                {% for form in ['GmbH', 'AG', 'KG', 'OHG', 'GbR', 'e.K.', 'UG', 'Einzelunternehmen'] %}
                                <option value="{{ form }}" {% if customer and customer.legal_form == form %}selected{% endif %}>{{ form }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        {# Email #}
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">E-Mail *</span>
                            </label>
                            <input type="email"
                                   name="email"
                                   value="{{ customer.email if customer else '' }}"
                                   class="input input-bordered"
                                   required>
                        </div>

                        {# Phone #}
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Telefon</span>
                            </label>
                            <input type="tel"
                                   name="phone"
                                   value="{{ customer.phone if customer else '' }}"
                                   class="input input-bordered">
                        </div>

                        {# Website #}
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Website</span>
                            </label>
                            <input type="url"
                                   name="website"
                                   value="{{ customer.website if customer else '' }}"
                                   class="input input-bordered"
                                   placeholder="https://...">
                        </div>

                        {# VAT ID #}
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">USt-IdNr.</span>
                                <span class="label-text-alt">Format: DE123456789</span>
                            </label>
                            <input type="text"
                                   name="vat_id"
                                   value="{{ customer.vat_id if customer else '' }}"
                                   class="input input-bordered"
                                   placeholder="DE123456789"
                                   pattern="DE[0-9]{9}">
                        </div>

                        {# Tax Number #}
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Steuernummer</span>
                            </label>
                            <input type="text"
                                   name="tax_number"
                                   value="{{ customer.tax_number if customer else '' }}"
                                   class="input input-bordered">
                        </div>

                        {# Status (only when editing) #}
                        {% if customer %}
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Status</span>
                            </label>
                            <select name="status" class="select select-bordered">
                                <option value="active" {% if customer.status == 'active' %}selected{% endif %}>Aktiv</option>
                                <option value="inactive" {% if customer.status == 'inactive' %}selected{% endif %}>Inaktiv</option>
                                <option value="blocked" {% if customer.status == 'blocked' %}selected{% endif %}>Gesperrt</option>
                            </select>
                        </div>
                        {% endif %}

                        {# Notes #}
                        <div class="form-control md:col-span-2">
                            <label class="label">
                                <span class="label-text">Interne Notizen</span>
                            </label>
                            <textarea name="notes"
                                      class="textarea textarea-bordered"
                                      rows="3"
                                      placeholder="Interne Notizen zu diesem Kunden...">{{ customer.notes if customer else '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            {# Address Card (only for new customers without saved addresses) #}
            {% if not customer %}
            <div class="card bg-base-100 shadow mb-6">
                <div class="card-body">
                    <h2 class="card-title text-lg mb-4">
                        <i class="ti ti-map-pin text-primary"></i> Adresse
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control md:col-span-2">
                            <label class="label">
                                <span class="label-text">Straße & Hausnummer</span>
                            </label>
                            <input type="text"
                                   name="street"
                                   class="input input-bordered"
                                   placeholder="Musterstraße 123">
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">PLZ</span>
                            </label>
                            <input type="text"
                                   name="zip_code"
                                   class="input input-bordered"
                                   placeholder="12345">
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Ort</span>
                            </label>
                            <input type="text"
                                   name="city"
                                   class="input input-bordered"
                                   placeholder="Musterstadt">
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Land</span>
                            </label>
                            <select name="country" class="select select-bordered">
                                <option value="DE" selected>Deutschland</option>
                                <option value="AT">Österreich</option>
                                <option value="CH">Schweiz</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {# Save Button #}
            <div class="flex justify-end gap-2">
                <a href="{{ url_for('crm_admin.list_customers') }}" class="btn btn-ghost">Abbrechen</a>
                <button type="submit" class="btn btn-primary">
                    <i class="ti ti-device-floppy mr-1"></i>
                    {% if customer %}Speichern{% else %}Kunde anlegen{% endif %}
                </button>
            </div>
        </form>
    </div>

    {# Sidebar #}
    <div class="lg:col-span-1">
        {% if customer %}
        {# Customer Info Card #}
        <div class="card bg-base-100 shadow mb-6">
            <div class="card-body">
                <h3 class="card-title text-base mb-4">
                    <i class="ti ti-info-circle text-primary"></i> Info
                </h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Kundennummer</span>
                        <span class="font-mono">{{ customer.customer_number }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Angelegt</span>
                        <span>{{ customer.created_at.strftime('%d.%m.%Y') }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Geändert</span>
                        <span>{{ customer.updated_at.strftime('%d.%m.%Y %H:%M') }}</span>
                    </div>
                </div>
            </div>
        </div>

        {# Addresses Card #}
        <div class="card bg-base-100 shadow mb-6">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="card-title text-base">
                        <i class="ti ti-map-pin text-primary"></i> Adressen
                    </h3>
                    <button type="button"
                            onclick="document.getElementById('add_address_modal').showModal()"
                            class="btn btn-ghost btn-xs">
                        <i class="ti ti-plus"></i>
                    </button>
                </div>

                {% if addresses %}
                <div class="space-y-3">
                    {% for address in addresses %}
                    <div class="border border-base-200 rounded-lg p-3 text-sm">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-1">
                                {% if address.is_default_billing %}
                                <span class="badge badge-primary badge-xs">Rechnung</span>
                                {% endif %}
                                {% if address.is_default_shipping %}
                                <span class="badge badge-secondary badge-xs">Lieferung</span>
                                {% endif %}
                            </div>
                            <form method="POST"
                                  action="{{ url_for('crm_admin.delete_address', address_id=address.id) }}"
                                  onsubmit="return confirm('Adresse löschen?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-ghost btn-xs text-error">
                                    <i class="ti ti-trash"></i>
                                </button>
                            </form>
                        </div>
                        <div class="text-base-content/80">
                            {{ address.street }}<br>
                            {% if address.street2 %}{{ address.street2 }}<br>{% endif %}
                            {{ address.zip_code }} {{ address.city }}<br>
                            {{ address.country_name }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-sm text-base-content/60 text-center py-4">
                    Noch keine Adressen vorhanden
                </p>
                {% endif %}
            </div>
        </div>

        {# Shop Access Card #}
        <div class="card bg-base-100 shadow mb-6">
            <div class="card-body">
                <h3 class="card-title text-base mb-4">
                    <i class="ti ti-key text-primary"></i> Shop-Zugang
                </h3>

                {% if customer.auth and customer.auth.is_active %}
                {# Shop access enabled #}
                <div class="alert alert-success mb-4">
                    <i class="ti ti-check"></i>
                    <span>Shop-Zugang aktiv</span>
                </div>

                <div class="space-y-2 text-sm mb-4">
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Login-E-Mail</span>
                        <span>{{ customer.auth.email }}</span>
                    </div>
                    {% if customer.auth.last_login %}
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Letzter Login</span>
                        <span>{{ customer.auth.last_login.strftime('%d.%m.%Y %H:%M') }}</span>
                    </div>
                    {% endif %}
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Logins gesamt</span>
                        <span>{{ customer.auth.login_count }}</span>
                    </div>
                    {% if customer.auth.is_locked %}
                    <div class="alert alert-warning text-xs py-2 px-3">
                        <i class="ti ti-lock"></i>
                        <span>Account gesperrt bis {{ customer.auth.locked_until.strftime('%d.%m.%Y %H:%M') }}</span>
                    </div>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    {# Unlock Account #}
                    {% if customer.auth.is_locked %}
                    <form method="POST" action="{{ url_for('crm_admin.unlock_account', customer_id=customer.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-warning btn-sm w-full">
                            <i class="ti ti-lock-open mr-1"></i> Account entsperren
                        </button>
                    </form>
                    {% endif %}

                    {# Reset Password #}
                    <button type="button"
                            onclick="document.getElementById('reset_password_modal').showModal()"
                            class="btn btn-outline btn-sm w-full">
                        <i class="ti ti-key mr-1"></i> Passwort zurücksetzen
                    </button>

                    {# Disable Access #}
                    <form method="POST" action="{{ url_for('crm_admin.disable_shop_access', customer_id=customer.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-ghost btn-sm w-full text-error">
                            <i class="ti ti-ban mr-1"></i> Zugang deaktivieren
                        </button>
                    </form>
                </div>
                {% else %}
                {# No shop access #}
                <div class="alert alert-warning mb-4">
                    <i class="ti ti-alert-circle"></i>
                    <span>Kein Shop-Zugang</span>
                </div>

                <button type="button"
                        onclick="document.getElementById('enable_access_modal').showModal()"
                        class="btn btn-primary btn-sm w-full">
                    <i class="ti ti-key mr-1"></i> Shop-Zugang aktivieren
                </button>
                {% endif %}
            </div>
        </div>

        {# Delete Customer Card #}
        <div class="card bg-base-100 shadow border border-error/20">
            <div class="card-body">
                <h3 class="card-title text-base text-error mb-4">
                    <i class="ti ti-alert-triangle"></i> Gefahrenzone
                </h3>
                <form method="POST"
                      action="{{ url_for('crm_admin.delete_customer', customer_id=customer.id) }}"
                      onsubmit="return confirm('Kunde wirklich unwiderruflich löschen?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-error btn-sm w-full">
                        <i class="ti ti-trash mr-1"></i> Kunde löschen
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if customer %}
{# Add Address Modal #}
<dialog id="add_address_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">
            <i class="ti ti-map-pin text-primary mr-2"></i>Neue Adresse hinzufügen
        </h3>
        <form method="POST" action="{{ url_for('crm_admin.add_address', customer_id=customer.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="space-y-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Straße & Hausnummer *</span>
                    </label>
                    <input type="text" name="street" class="input input-bordered" required>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Adresszusatz</span>
                    </label>
                    <input type="text" name="street2" class="input input-bordered" placeholder="Gebäude, Etage, etc.">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">PLZ *</span>
                        </label>
                        <input type="text" name="zip_code" class="input input-bordered" required>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Ort *</span>
                        </label>
                        <input type="text" name="city" class="input input-bordered" required>
                    </div>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Land</span>
                    </label>
                    <select name="country" class="select select-bordered">
                        <option value="DE" selected>Deutschland</option>
                        <option value="AT">Österreich</option>
                        <option value="CH">Schweiz</option>
                    </select>
                </div>

                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-3">
                        <input type="checkbox" name="is_default_billing" class="checkbox checkbox-primary">
                        <span class="label-text">Standard-Rechnungsadresse</span>
                    </label>
                </div>

                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-3">
                        <input type="checkbox" name="is_default_shipping" class="checkbox checkbox-primary">
                        <span class="label-text">Standard-Lieferadresse</span>
                    </label>
                </div>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="document.getElementById('add_address_modal').close()">Abbrechen</button>
                <button type="submit" class="btn btn-primary">Adresse hinzufügen</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{# Enable Shop Access Modal #}
<dialog id="enable_access_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">
            <i class="ti ti-key text-primary mr-2"></i>Shop-Zugang aktivieren
        </h3>
        <form method="POST" action="{{ url_for('crm_admin.enable_shop_access', customer_id=customer.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="alert alert-info mb-4">
                <i class="ti ti-info-circle"></i>
                <span>Der Kunde kann sich mit <strong>{{ customer.email }}</strong> und dem festgelegten Passwort einloggen.</span>
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text">Initiales Passwort *</span>
                </label>
                <input type="password"
                       name="password"
                       class="input input-bordered"
                       minlength="8"
                       required>
                <label class="label">
                    <span class="label-text-alt">Mindestens 8 Zeichen</span>
                </label>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="document.getElementById('enable_access_modal').close()">Abbrechen</button>
                <button type="submit" class="btn btn-primary">Zugang aktivieren</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{# Reset Password Modal #}
<dialog id="reset_password_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">
            <i class="ti ti-key text-primary mr-2"></i>Passwort zurücksetzen
        </h3>
        <form method="POST" action="{{ url_for('crm_admin.reset_password', customer_id=customer.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="form-control">
                <label class="label">
                    <span class="label-text">Neues Passwort *</span>
                </label>
                <input type="password"
                       name="new_password"
                       class="input input-bordered"
                       minlength="8"
                       required>
                <label class="label">
                    <span class="label-text-alt">Mindestens 8 Zeichen</span>
                </label>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="document.getElementById('reset_password_modal').close()">Abbrechen</button>
                <button type="submit" class="btn btn-primary">Passwort setzen</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{% endif %}
{% endblock %}
