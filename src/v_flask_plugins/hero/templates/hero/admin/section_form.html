{% extends "admin/base.html" %}

{% block title %}{% if hero %}Hero Section bearbeiten{% else %}Neue Hero Section{% endif %}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs text-sm">
    <ul>
        <li><a href="{{ url_for('admin.dashboard') }}"><i class="ti ti-home"></i> Admin</a></li>
        <li><i class="ti ti-file-text mr-1"></i>Inhalte</li>
        <li><a href="{{ url_for('hero_admin.list_sections') }}">Hero Sections</a></li>
        <li>{% if hero %}{{ hero.display_name }}{% else %}Neu{% endif %}</li>
    </ul>
</div>
{% endblock %}

{% block admin_content %}
{# Title Bar #}
<div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold flex items-center gap-2">
        <i class="ti ti-photo text-primary"></i>
        <span>{% if hero %}{{ hero.display_name }}{% else %}Neue Hero Section{% endif %}</span>
    </h1>
    <div class="flex gap-2">
        {% if hero %}
        <button type="button"
                onclick="document.getElementById('delete-modal').showModal()"
                class="btn btn-ghost btn-sm text-error">
            <i class="ti ti-trash mr-1"></i> Löschen
        </button>
        {% endif %}
        <a href="{{ url_for('hero_admin.list_sections') }}" class="btn btn-ghost btn-sm">
            <i class="ti ti-arrow-left mr-1"></i> Zurück
        </a>
        <button type="submit" form="section-form" class="btn btn-primary btn-sm">
            <i class="ti ti-device-floppy mr-1"></i> Speichern
        </button>
    </div>
</div>

{# Collapsible Preview Panel #}
{% if hero and preview_html %}
<div class="collapse collapse-arrow bg-base-200 mb-6 max-w-4xl">
    <input type="checkbox" checked>
    <div class="collapse-title text-sm font-medium flex items-center gap-2">
        <i class="ti ti-eye"></i>Vorschau
    </div>
    <div class="collapse-content">
        <div class="rounded-lg overflow-hidden bg-base-100 p-4">
            <div class="transform scale-75 origin-top-left w-[133%]">
                {{ preview_html|safe }}
            </div>
        </div>
    </div>
</div>
{% elif not hero %}
<div class="alert alert-info mb-6 max-w-4xl">
    <i class="ti ti-eye-off"></i>
    <span>Vorschau wird nach dem ersten Speichern verfügbar.</span>
</div>
{% endif %}

<div class="max-w-4xl">
    <form method="post"
              action="{% if hero %}{{ url_for('hero_admin.edit_section', section_id=hero.id) }}{% else %}{{ url_for('hero_admin.create_section') }}{% endif %}"
              id="section-form"
              enctype="multipart/form-data">
            {% include 'v_flask/includes/_csrf.html' %}

            {# Basic Info #}
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h2 class="card-title">
                        <i class="ti ti-info-circle"></i>
                        Grundeinstellungen
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Name (intern)</span>
                            </label>
                            <input type="text" name="name"
                                   value="{{ hero.name or '' if hero else '' }}"
                                   class="input input-bordered"
                                   placeholder="z.B. Homepage Hero, Winter-Aktion">
                            <label class="label">
                                <span class="label-text-alt">Zur Identifizierung im Admin</span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" name="active" value="1"
                                       class="checkbox checkbox-primary"
                                       {% if (hero and hero.active) or not hero %}checked{% endif %}>
                                <span class="label-text">Aktiv</span>
                            </label>
                            <label class="label">
                                <span class="label-text-alt">Inaktive Sections werden nicht angezeigt</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            {# Variant Selection #}
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h2 class="card-title">
                        <i class="ti ti-layout"></i>
                        Layout-Variante
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {% for variant in variants %}
                        <label class="cursor-pointer">
                            <input type="radio" name="variant" value="{{ variant.value }}"
                                   class="peer hidden"
                                   {% if (hero and hero.variant == variant.value) or (not hero and variant.value == 'centered') %}checked{% endif %}>
                            <div class="card bg-base-200 peer-checked:ring-2 peer-checked:ring-primary transition-all hover:bg-base-300">
                                <div class="card-body p-3">
                                    <div class="aspect-video bg-base-300 rounded mb-2 relative overflow-hidden">
                                        {% if variant.value == 'centered' %}
                                        <div class="absolute inset-0 bg-gradient-to-br from-primary/30 to-accent/30"></div>
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <div class="text-center">
                                                <div class="w-6 h-1 bg-base-content/40 mx-auto mb-1 rounded"></div>
                                                <div class="w-10 h-1 bg-base-content/30 mx-auto rounded"></div>
                                            </div>
                                        </div>
                                        {% elif variant.value == 'split' %}
                                        <div class="flex gap-1 p-1 h-full">
                                            <div class="w-1/2 bg-gradient-to-br from-primary/30 to-accent/30 rounded"></div>
                                            <div class="w-1/2 flex flex-col justify-center p-1">
                                                <div class="w-full h-1 bg-base-content/40 mb-1 rounded"></div>
                                                <div class="w-2/3 h-1 bg-base-content/30 rounded"></div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="absolute inset-0 bg-gradient-to-br from-primary/30 to-accent/30"></div>
                                        <div class="absolute inset-0 bg-gradient-to-b from-black/50 to-black/50"></div>
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <div class="text-center">
                                                <div class="w-8 h-1.5 bg-white/60 mx-auto mb-1 rounded"></div>
                                                <div class="w-12 h-1 bg-white/40 mx-auto rounded"></div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <span class="text-sm font-medium">{{ variant.label }}</span>
                                </div>
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {# Background Image #}
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h2 class="card-title">
                        <i class="ti ti-photo-up"></i>
                        Hintergrundbild
                    </h2>

                    <input type="hidden" name="media_id" id="media_id"
                           value="{{ hero.media_id or '' if hero else '' }}">

                    <div id="image-preview-area" class="mb-4">
                        {% if hero and hero.media %}
                        <div class="relative">
                            <img src="{{ hero.media.get_url('medium') }}"
                                 alt="{{ hero.media.alt_text or 'Hero Bild' }}"
                                 class="w-full max-h-48 object-cover rounded-lg">
                            <button type="button"
                                    onclick="clearMediaSelection()"
                                    class="btn btn-sm btn-circle btn-error absolute top-2 right-2">
                                <i class="ti ti-x"></i>
                            </button>
                        </div>
                        {% else %}
                        <div class="border-2 border-dashed border-base-300 rounded-lg p-8 text-center">
                            <i class="ti ti-photo text-4xl text-base-content/30 mb-2"></i>
                            <p class="text-base-content/60 text-sm">Noch kein Bild ausgewählt</p>
                        </div>
                        {% endif %}
                    </div>

                    <button type="button"
                            onclick="openMediaPicker()"
                            class="btn btn-outline btn-primary w-full">
                        <i class="ti ti-photo-plus mr-1"></i>
                        {% if hero and hero.media %}Bild ändern{% else %}Bild auswählen{% endif %}
                    </button>
                </div>
            </div>

            {# Text Content #}
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h2 class="card-title">
                        <i class="ti ti-text-size"></i>
                        Text-Inhalt
                    </h2>

                    {# Text Source Toggle #}
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text font-medium">Text-Quelle</span>
                        </label>
                        <div class="flex gap-4">
                            <label class="cursor-pointer flex items-center gap-2">
                                <input type="radio" name="text_source" value="custom"
                                       class="radio radio-primary"
                                       {% if not hero or not hero.template_id %}checked{% endif %}
                                       onchange="toggleTextSource('custom')">
                                <span>Eigener Text</span>
                            </label>
                            <label class="cursor-pointer flex items-center gap-2">
                                <input type="radio" name="text_source" value="template"
                                       class="radio radio-primary"
                                       {% if hero and hero.template_id %}checked{% endif %}
                                       onchange="toggleTextSource('template')">
                                <span>Vorlage</span>
                            </label>
                        </div>
                    </div>

                    {# Template Selection #}
                    <div id="template-selection" class="{% if not hero or not hero.template_id %}hidden{% endif %}">
                        <div class="form-control mb-4">
                            <label class="label">
                                <span class="label-text">Vorlage auswählen</span>
                            </label>
                            <select name="template_id" class="select select-bordered w-full">
                                <option value="">-- Vorlage wählen --</option>
                                {% for tpl in templates %}
                                <option value="{{ tpl.id }}" {% if hero and hero.template_id == tpl.id %}selected{% endif %}>
                                    {{ tpl.name }}{% if tpl.is_default %} (Standard){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    {# Custom Text #}
                    <div id="custom-text" class="{% if hero and hero.template_id %}hidden{% endif %}">
                        <div class="form-control mb-4">
                            <label class="label">
                                <span class="label-text">Titel</span>
                            </label>
                            <input type="text" name="custom_title"
                                   value="{{ hero.custom_title or '' if hero else '' }}"
                                   class="input input-bordered"
                                   placeholder="Willkommen bei...">
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Untertitel</span>
                            </label>
                            <textarea name="custom_subtitle"
                                      class="textarea textarea-bordered"
                                      rows="2"
                                      placeholder="Entdecke die besten...">{{ hero.custom_subtitle or '' if hero else '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            {# CTA Button #}
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h2 class="card-title">
                        <i class="ti ti-click"></i>
                        Call-to-Action
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Button-Text</span>
                            </label>
                            <input type="text" name="cta_text"
                                   value="{{ hero.cta_text or '' if hero else '' }}"
                                   class="input input-bordered"
                                   placeholder="Jetzt entdecken">
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Button-Link</span>
                            </label>
                            <input type="text" name="cta_link"
                                   value="{{ hero.cta_link or '' if hero else '' }}"
                                   class="input input-bordered"
                                   placeholder="/entdecken">
                        </div>
                    </div>
                </div>
            </div>
        </form>

        {# Page Assignments (only for existing sections) #}
        {% if hero %}
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <h2 class="card-title">
                    <i class="ti ti-link"></i>
                    Seiten-Zuweisungen
                </h2>

                <p class="text-sm text-base-content/70 mb-4">
                    Auf welchen Seiten soll diese Hero Section angezeigt werden?
                </p>

                <div id="assignments-container">
                    {% include 'hero/admin/_assignments.html' %}
                </div>
            </div>
        </div>

        {% endif %}
</div>

{# Media Picker Modal #}
<dialog id="media-picker-modal" class="modal">
    <div class="modal-box w-11/12 max-w-4xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
                <i class="ti ti-x"></i>
            </button>
        </form>
        <h3 class="font-bold text-lg mb-4">
            <i class="ti ti-photo mr-2"></i>Bild auswählen
        </h3>
        <div id="media-picker-content"
             hx-get="{{ url_for('media_admin.picker', field='media_id', accept='image/*') }}"
             hx-trigger="load">
            <div class="flex justify-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{# Delete Confirmation Modal #}
{% if hero %}
<dialog id="delete-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg text-error">
            <i class="ti ti-alert-triangle mr-2"></i>Hero Section löschen
        </h3>
        <p class="py-4">
            Diese Aktion kann nicht rückgängig gemacht werden.
            Alle Zuweisungen werden ebenfalls gelöscht.
        </p>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-ghost">Abbrechen</button>
            </form>
            <form method="post" action="{{ url_for('hero_admin.delete_section', section_id=hero.id) }}">
                {% include 'v_flask/includes/_csrf.html' %}
                <button type="submit" class="btn btn-error">
                    <i class="ti ti-trash mr-1"></i> Endgültig löschen
                </button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{% endif %}

<script>
function toggleTextSource(source) {
    const templateSection = document.getElementById('template-selection');
    const customSection = document.getElementById('custom-text');

    if (source === 'template') {
        templateSection.classList.remove('hidden');
        customSection.classList.add('hidden');
    } else {
        templateSection.classList.add('hidden');
        customSection.classList.remove('hidden');
    }
}

function openMediaPicker() {
    const modal = document.getElementById('media-picker-modal');
    htmx.trigger('#media-picker-content', 'load');
    modal.showModal();
}

document.addEventListener('media-selected', function(e) {
    const { mediaId, url, altText, fieldName } = e.detail;

    document.getElementById('media_id').value = mediaId;

    const previewArea = document.getElementById('image-preview-area');
    previewArea.innerHTML = `
        <div class="relative">
            <img src="${url}" alt="${altText || 'Hero Bild'}"
                 class="w-full max-h-48 object-cover rounded-lg">
            <button type="button"
                    onclick="clearMediaSelection()"
                    class="btn btn-sm btn-circle btn-error absolute top-2 right-2">
                <i class="ti ti-x"></i>
            </button>
        </div>
    `;

    document.getElementById('media-picker-modal').close();
});

function clearMediaSelection() {
    document.getElementById('media_id').value = '';
    const previewArea = document.getElementById('image-preview-area');
    previewArea.innerHTML = `
        <div class="border-2 border-dashed border-base-300 rounded-lg p-8 text-center">
            <i class="ti ti-photo text-4xl text-base-content/30 mb-2"></i>
            <p class="text-base-content/60 text-sm">Noch kein Bild ausgewählt</p>
        </div>
    `;
}
</script>
{% endblock %}
