<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% block meta %}{% endblock %}

    <title>{% block title %}{{ get_betreiber().name if get_betreiber() else 'v-flask App' }}{% endblock %}</title>

    {# Favicon #}
    {% block favicon %}
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    {% endblock %}

    {# CSS: DaisyUI + Tailwind, Tabler Icons, v-flask.css #}
    {% block head_css %}
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    {% set betreiber = get_betreiber() %}
    {% if betreiber and betreiber.google_fonts_url %}
    <link href="{{ betreiber.google_fonts_url }}" rel="stylesheet">
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('v_flask_static.static', filename='tabler-icons/tabler-icons.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('v_flask_static.static', filename='css/v-flask.css') }}">
    {% endblock %}

    {# Dynamic Branding CSS Variables from Betreiber #}
    {% block branding_css %}
    {% set betreiber = get_betreiber() %}
    {% if betreiber %}
    <style>{{ betreiber.get_css_variables()|safe }}</style>
    {% endif %}
    {% endblock %}

    {# Additional CSS from child templates #}
    {% block extra_css %}{% endblock %}
</head>
<body class="min-h-screen flex flex-col bg-base-100">
    {% block body_start %}{% endblock %}

    {# Navbar #}
    {% block navbar %}
    <div class="navbar bg-primary text-primary-content mb-4">
        <div class="container mx-auto">
            {% block navbar_brand %}
            <div class="flex-1">
                {% set betreiber = get_betreiber() %}
                <a class="btn btn-ghost text-xl" href="{{ url_for('main.dashboard') if 'main.dashboard' in self._TemplateReference__context.keys()|list else '/' }}">
                    {% if betreiber and betreiber.logo_url %}
                    <img src="{{ betreiber.logo_url }}" alt="{{ betreiber.name }}" class="h-8">
                    {% endif %}
                    {{ betreiber.name if betreiber else 'v-flask' }}
                </a>
            </div>
            {% endblock %}

            {% block navbar_left %}
            <div class="flex-none hidden lg:flex">
                <ul class="menu menu-horizontal px-1">
                    {# Host-App can add navigation items here using {{ super() }} #}
                    {# Plugin Navbar Items (from ui_slots) #}
                    {% for item in get_plugin_slots('navbar_items') %}
                    <li>
                        <a href="{{ url_for(item.url) }}">
                            {% if item.icon %}<i class="{{ item.icon }}"></i>{% endif %}
                            {{ item.label }}
                            {% if item.badge %}<span class="badge badge-error badge-sm">{{ item.badge }}</span>{% endif %}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endblock %}

            {% block navbar_right %}
            <div class="flex-none">
                {% if current_user.is_authenticated %}
                <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-ghost">
                        <i class="ti ti-user"></i>
                        <span class="hidden sm:inline">{{ current_user.vorname or current_user.email }}</span>
                        <i class="ti ti-chevron-down text-xs"></i>
                    </div>
                    <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow text-base-content">
                        {% block user_dropdown %}
                        <li class="menu-title">
                            <span class="text-xs">{{ current_user.email }}</span>
                        </li>
                        <li>
                            <a href="{{ url_for('auth.logout') }}">
                                <i class="ti ti-logout"></i> Abmelden
                            </a>
                        </li>
                        {% endblock %}
                    </ul>
                </div>
                {% else %}
                <a class="btn btn-ghost" href="{{ url_for('auth.login') }}">
                    <i class="ti ti-login"></i>
                    <span class="hidden sm:inline">Anmelden</span>
                </a>
                {% endif %}
            </div>
            {% endblock %}

            {# Mobile menu toggle #}
            <div class="flex-none lg:hidden">
                <label for="mobile-drawer" class="btn btn-square btn-ghost">
                    <i class="ti ti-menu-2 text-xl"></i>
                </label>
            </div>
        </div>
    </div>
    {% endblock %}

    {# Toast Container for Flash Messages #}
    {% block toast_container %}
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="toast toast-top toast-end z-50">
        {% for category, message in messages %}
        <div class="alert alert-{{ 'success' if category == 'success' else 'info' if category == 'info' else 'warning' if category == 'warning' else 'error' if category in ['error', 'danger'] else 'info' }}">
            {% if category == 'success' %}<i class="ti ti-check"></i>{% endif %}
            {% if category in ['error', 'danger'] %}<i class="ti ti-alert-circle"></i>{% endif %}
            {% if category == 'warning' %}<i class="ti ti-alert-triangle"></i>{% endif %}
            {% if category == 'info' %}<i class="ti ti-info-circle"></i>{% endif %}
            <span>{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    {% endblock %}

    {# Main Content #}
    {% block main %}
    <main class="container mx-auto px-4 flex-grow">
        {% block content %}{% endblock %}
    </main>
    {% endblock %}

    {# Footer #}
    {% block footer %}
    <footer class="footer footer-center p-4 bg-base-200 text-base-content mt-auto">
        <div class="container mx-auto">
            <div class="flex flex-col md:flex-row items-center justify-between w-full gap-4">
                {# Plugin Footer Links (from ui_slots) #}
                {% set footer_links = get_plugin_slots('footer_links') %}
                {% if footer_links %}
                <nav class="flex gap-4 flex-wrap justify-center md:justify-start">
                    {% for item in footer_links %}
                    <a href="{{ url_for(item.url) }}" class="link link-hover text-sm">
                        {% if item.icon %}<i class="{{ item.icon }}"></i>{% endif %}
                        {{ item.label }}
                    </a>
                    {% endfor %}
                </nav>
                {% endif %}
                {% block footer_content %}
                <aside class="text-sm text-base-content/70">
                    {% set betreiber = get_betreiber() %}
                    {{ betreiber.name if betreiber else 'v-flask' }}
                    | Powered by <a href="https://github.com/CarstenVogelsang/v-flask" target="_blank" class="link link-hover">v-flask</a> {{ v_flask_version }}
                </aside>
                {% endblock %}
            </div>
        </div>
    </footer>
    {% endblock %}

    {# Modals - Icon Picker, Help, etc. go here #}
    {% block modals %}{% endblock %}

    {% block body_end %}{% endblock %}

    {# No JavaScript needed - DaisyUI components work without JS #}
    {% block scripts_base %}{% endblock %}

    {# Additional JavaScript from child templates #}
    {% block extra_js %}{% endblock %}
</body>
</html>
