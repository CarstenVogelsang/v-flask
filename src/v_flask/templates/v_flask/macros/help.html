{#
    Help Icon Macro with Modal (DaisyUI)

    IMPORTANT: Import with "with context" to access template context!

    Usage:
        from "v_flask/macros/help.html" import help_icon with context

        <div class="card-header">
            Branchen help_icon('kunden.detail.branchen', 'Hilfe zu Branchen')
        </div>

    Prerequisites:
        - Context processor must provide get_help_text(schluessel) function
        - Model: Hilfetext with fields: schluessel, titel, inhalt_markdown, aktiv

    Parameters:
        - schluessel: Unique key for help text (e.g., 'modul.seite.bereich')
        - titel: Fallback title if help text not found or no title set
        - light: True for white icons on dark backgrounds
#}

{% macro help_icon(schluessel, titel=None, light=false) %}
{% if get_help_text is defined %}
{% set help = get_help_text(schluessel) %}
{% set modal_id = 'helpModal_' ~ schluessel|replace('.', '_') %}
{% if help and help.aktiv %}
<button type="button"
        class="btn btn-ghost btn-xs p-0 ml-2"
        onclick="document.getElementById('{{ modal_id }}').showModal()"
        title="Hilfe anzeigen">
    <i class="ti ti-info-circle text-lg {{ 'text-base-content/50' if light else 'text-base-content/60' }}"></i>
</button>

<dialog id="{{ modal_id }}" class="modal">
    <div class="modal-box max-w-2xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
                <i class="ti ti-x"></i>
            </button>
        </form>
        <h3 class="font-bold text-lg flex items-center gap-2">
            <i class="ti ti-info-circle text-info"></i>
            {{ help.titel or titel or 'Hilfe' }}
        </h3>
        <div class="py-4 prose max-w-none">
            {% if help.inhalt_markdown %}
            {{ help.inhalt_markdown|markdown|safe }}
            {% else %}
            <p class="text-base-content/50">Keine Hilfe verfügbar.</p>
            {% endif %}
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{% endif %}
{% endif %}
{% endmacro %}


{#
    Standalone Help Modal (without button)

    Use when you need to trigger the modal from somewhere else.

    Usage:
        from "v_flask/macros/help.html" import help_modal with context

        help_modal('kunden.detail.branchen')

        <button onclick="document.getElementById('helpModal_kunden_detail_branchen').showModal()">
            Custom trigger
        </button>
#}

{% macro help_modal(schluessel, titel=None) %}
{% if get_help_text is defined %}
{% set help = get_help_text(schluessel) %}
{% set modal_id = 'helpModal_' ~ schluessel|replace('.', '_') %}
{% if help and help.aktiv %}
<dialog id="{{ modal_id }}" class="modal">
    <div class="modal-box max-w-2xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
                <i class="ti ti-x"></i>
            </button>
        </form>
        <h3 class="font-bold text-lg flex items-center gap-2">
            <i class="ti ti-info-circle text-info"></i>
            {{ help.titel or titel or 'Hilfe' }}
        </h3>
        <div class="py-4 prose max-w-none">
            {% if help.inhalt_markdown %}
            {{ help.inhalt_markdown|markdown|safe }}
            {% else %}
            <p class="text-base-content/50">Keine Hilfe verfügbar.</p>
            {% endif %}
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{% endif %}
{% endif %}
{% endmacro %}


{#
    Simple Info Tooltip (no database lookup)

    For simple inline help without database lookup.

    Usage:
        from "v_flask/macros/help.html" import info_tooltip

        Feldname info_tooltip('Diese Information wird...')
#}

{% macro info_tooltip(text, light=false) %}
<span class="ml-1 tooltip" data-tip="{{ text }}">
    <i class="ti ti-info-circle {{ 'text-base-content/50' if light else 'text-base-content/60' }}"></i>
</span>
{% endmacro %}
